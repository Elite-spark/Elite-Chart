<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Spark - Ultimate Interaction</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000000; font-family: 'Segoe UI', sans-serif; }
        #chart { width: 100vw; height: 100vh; z-index: 1; }
        
        /* ÿßŸÑÿ≥ÿ™ÿßŸäŸÑ ÿßŸÑŸÖŸÑŸÉŸä ŸÖÿ≠ŸÅŸàÿ∏ ÿ®ÿØŸÇÿ© */
        .brand-container {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            color: #FFD700; pointer-events: none;
            display: flex; flex-direction: column; align-items: center;
        }
        .brand-container h1 { margin: 0; font-size: 18px; letter-spacing: 2px; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .brand-container p { margin: 2px 0; font-size: 12px; opacity: 0.8; }
        .user-logo { width: 45px; height: 45px; margin-top: 8px; }

        #countdown-box {
            position: absolute; top: 20px; right: 80px; z-index: 10;
            display: flex; flex-direction: column; align-items: center;
            background: rgba(20, 20, 20, 0.8); border: 1px solid #FFD700;
            padding: 5px 12px; border-radius: 8px; min-width: 60px;
        }
        #countdown { color: #FFD700; font-weight: bold; font-size: 16px; font-family: 'Courier New', monospace; }

        .drawing-controls {
            position: absolute; top: 22px; right: 180px; z-index: 20;
            display: flex; flex-direction: row; gap: 10px;
        }
        .draw-btn {
            background: rgba(0,0,0,0.6); border: 1px solid #FFD700; color: #FFD700;
            width: 40px; height: 40px; border-radius: 5px; cursor: pointer; font-size: 18px;
        }

        .timeframes {
            position: absolute; bottom: 30px; left: 20px; z-index: 20; display: flex; gap: 10px;
        }
        .tf-btn {
            background: #000; border: 1px solid #FFD700; color: #FFD700;
            padding: 6px 15px; border-radius: 6px; cursor: pointer; font-size: 12px;
        }
        .tf-btn.active { background: #FFD700; color: #000; font-weight: bold; }
    </style>
</head>
<body>
    
    <div id="countdown-box">
        <div style="color: #FFD700; font-size: 9px;">NEXT CANDLE</div>
        <div id="countdown">00:00</div>
    </div>
    
    <div class="brand-container">
        <h1>ELITE SPARK</h1>
        <p>XAU/USD - GOLD LIVE</p>
        <img src="https://i.ibb.co/R4kwHrMc/image.png" class="user-logo" alt="Logo">
    </div>

    <div class="drawing-controls">
        <button class="draw-btn" onclick="addPriceLine()">‚ûï</button>
        <button class="draw-btn" style="color:red" onclick="clearAllDrawings()">üóëÔ∏è</button>
    </div>

    <div class="timeframes">
        <button class="tf-btn" onclick="changeTf('1m', this)">1M</button>
        <button class="tf-btn" onclick="changeTf('5m', this)">5M</button>
        <button class="tf-btn active" onclick="changeTf('15m', this)">15M</button>
    </div>

    <div id="chart"></div>

    <script>
        let currentInterval = '15m';
        let socket, countdownTimer;
        let eliteLines = []; 
        let savedPrices = JSON.parse(localStorage.getItem('elite_drawings') || '[]');
        
        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿ®
        let isDragging = false;
        let activeIndex = -1;
        let longPressTimer;

        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
            layout: { background: { color: '#000000' }, textColor: '#FFD700' },
            grid: { vertLines: { visible: false }, horzLines: { visible: false } },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            rightPriceScale: { borderColor: '#FFD700' },
            timeScale: { borderColor: '#FFD700', timeVisible: true }
        });

        const candleSeries = chart.addCandlestickSeries({
            upColor: '#FFD700', downColor: '#000',
            borderUpColor: '#FFD700', borderDownColor: '#FFD700',
            wickUpColor: '#FFD700', wickDownColor: '#FFD700'
        });

        // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿÆÿ∑Ÿàÿ∑
        function renderLines() {
            eliteLines.forEach(l => candleSeries.removePriceLine(l));
            eliteLines = [];
            savedPrices.forEach((p, index) => {
                const line = candleSeries.createPriceLine({
                    price: p, color: '#FFD700', lineWidth: 2,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: true, title: 'LEVEL ' + (index + 1)
                });
                eliteLines.push(line);
            });
        }

        function addPriceLine() {
            const data = candleSeries.data();
            if (!data.length) return;
            const price = data[data.length - 1].close;
            savedPrices.push(price);
            updateStorage();
            renderLines();
        }

        function updateStorage() {
            localStorage.setItem('elite_drawings', JSON.stringify(savedPrices));
        }

        // --- ŸÖÿ≠ÿ±ŸÉ ÿßŸÑÿ™ŸÅÿßÿπŸÑ ÿßŸÑŸÖÿ∑Ÿàÿ± (ŸÑŸÖÿ≥ + ŸÖÿßŸàÿ≥) ---
        const chartDiv = document.getElementById('chart');

        function handleStart(y) {
            const price = chart.priceScale('right').coordinateToPrice(y);
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿ≠ÿ≥ÿßÿ≥Ÿäÿ© 10 ŸÜŸÇÿßÿ∑ ŸÑÿ™ÿ≥ŸáŸäŸÑ ÿßŸÑŸÑŸÖÿ≥
            activeIndex = savedPrices.findIndex(p => Math.abs(p - price) < 10);
            
            if (activeIndex !== -1) {
                isDragging = true;
                // ÿ™ŸÅÿπŸäŸÑ ŸÖÿ§ŸÇÿ™ ŸÑŸÑÿ≠ÿ∞ŸÅ (ÿ•ÿ∞ÿß ÿ∂ÿ∫ÿ∑ÿ™ ŸÑÿ´ÿßŸÜŸäÿ© Ÿàÿßÿ≠ÿØÿ© ÿ≥Ÿäÿ≠ÿ∞ŸÅ ÿßŸÑÿÆÿ∑)
                longPressTimer = setTimeout(() => {
                    if (isDragging) {
                        if (confirm("ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿÆÿ∑ÿü")) {
                            savedPrices.splice(activeIndex, 1);
                            updateStorage();
                            renderLines();
                            isDragging = false;
                        }
                    }
                }, 800);
            }
        }

        function handleMove(y) {
            if (isDragging && activeIndex !== -1) {
                clearTimeout(longPressTimer); // ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ∞ŸÅ ŸÑÿ£ŸÜŸÜÿß ÿ®ÿØÿ£ŸÜÿß ŸÜÿ≥ÿ≠ÿ®
                const newPrice = chart.priceScale('right').coordinateToPrice(y);
                savedPrices[activeIndex] = newPrice;
                renderLines();
            }
        }

        function handleEnd() {
            isDragging = false;
            activeIndex = -1;
            clearTimeout(longPressTimer);
            updateStorage();
        }

        // ÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑŸÖÿßŸàÿ≥
        chartDiv.addEventListener('mousedown', (e) => handleStart(e.offsetY));
        window.addEventListener('mousemove', (e) => handleMove(e.offsetY));
        window.addEventListener('mouseup', handleEnd);

        // ÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑŸÑŸÖÿ≥ (ŸÑŸÑŸÖŸàÿ®ÿßŸäŸÑ)
        chartDiv.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            const rect = chartDiv.getBoundingClientRect();
            handleStart(touch.clientY - rect.top);
        }, {passive: false});

        chartDiv.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            const rect = chartDiv.getBoundingClientRect();
            handleMove(touch.clientY - rect.top);
            if (isDragging) e.preventDefault(); // ŸÖŸÜÿπ ÿßŸáÿ™ÿ≤ÿßÿ≤ ÿßŸÑÿµŸÅÿ≠ÿ© ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ≥ÿ≠ÿ®
        }, {passive: false});

        chartDiv.addEventListener('touchend', handleEnd);

        // --- ÿ®ŸÇŸäÿ© ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ---
        async function updateChartData(interval) {
            try {
                const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=PAXGUSDT&interval=${interval}&limit=500`);
                const raw = await res.json();
                candleSeries.setData(raw.map(d => ({
                    time: d[0] / 1000, open: parseFloat(d[1]), high: parseFloat(d[2]), low: parseFloat(d[3]), close: parseFloat(d[4])
                })));
                renderLines(); connectSocket(interval); setupCountdown(interval);
            } catch (e) { console.error(e); }
        }

        function connectSocket(interval) {
            if (socket) socket.close();
            socket = new WebSocket(`wss://stream.binance.com:9443/ws/paxgusdt@kline_${interval}`);
            socket.onmessage = (e) => {
                const k = JSON.parse(e.data).k;
                candleSeries.update({ time: k.t / 1000, open: parseFloat(k.o), high: parseFloat(k.h), low: parseFloat(k.l), close: parseFloat(k.c) });
            };
        }

        function setupCountdown(interval) {
            if (countdownTimer) clearInterval(countdownTimer);
            const ms = parseInt(interval) * 60000;
            countdownTimer = setInterval(() => {
                const left = ms - (Date.now() % ms);
                document.getElementById('countdown').innerText = `${Math.floor(left/60000).toString().padStart(2,'0')}:${Math.floor((left%60000)/1000).toString().padStart(2,'0')}`;
            }, 1000);
        }

        function changeTf(tf, btn) {
            currentInterval = tf;
            document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateChartData(tf);
        }

        function clearAllDrawings() {
            if(confirm("ŸÖÿ≥ÿ≠ ŸÉŸÑ ÿßŸÑÿ±ÿ≥ŸàŸÖÿü")) {
                savedPrices = []; renderLines(); updateStorage();
            }
        }

        updateChartData(currentInterval);
        window.onresize = () => chart.applyOptions({ width: window.innerWidth, height: window.innerHeight });
    </script>
</body>
</html>
