<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Spark - WebView Stable</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        #chart { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; }
        
        .brand-container {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            color: #FFD700; pointer-events: none; text-align: center;
        }
        .brand-container h1 { margin: 0; font-size: 16px; letter-spacing: 1.5px; }
        .user-logo { width: 40px; height: 40px; margin-top: 5px; }

        #countdown-box {
            position: absolute; top: 20px; right: 20px; z-index: 10;
            background: rgba(10, 10, 10, 0.9); border: 1px solid #FFD700;
            padding: 4px 10px; border-radius: 6px; color: #FFD700; text-align: center;
        }

        .drawing-controls {
            position: absolute; top: 80px; right: 20px; z-index: 20;
            display: flex; flex-direction: column; gap: 10px;
        }
        .draw-btn {
            background: rgba(0,0,0,0.8); border: 1.5px solid #FFD700; color: #FFD700;
            width: 42px; height: 42px; border-radius: 8px; cursor: pointer; font-size: 20px;
        }

        .timeframes {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 20; display: flex; gap: 8px;
        }
        .tf-btn {
            background: #000; border: 1px solid #FFD700; color: #FFD700;
            padding: 6px 12px; border-radius: 5px; font-size: 11px;
        }
        .tf-btn.active { background: #FFD700; color: #000; font-weight: bold; }
    </style>
</head>
<body>
    
    <div id="chart"></div>

    <div class="brand-container">
        <h1>ELITE SPARK</h1>
        <img src="https://i.ibb.co/R4kwHrMc/image.png" class="user-logo">
    </div>

    <div id="countdown-box">
        <div style="font-size: 8px;">NEXT CANDLE</div>
        <div id="countdown" style="font-size: 14px; font-weight: bold;">00:00</div>
    </div>

    <div class="drawing-controls">
        <button class="draw-btn" onclick="addEliteLine()">‚ûï</button>
        <button class="draw-btn" style="border-color: #ff4444; color: #ff4444;" onclick="clearAllDrawings()">üóëÔ∏è</button>
    </div>

    <div class="timeframes">
        <button class="tf-btn" onclick="changeTf('1m', this)">1M</button>
        <button class="tf-btn" onclick="changeTf('5m', this)">5M</button>
        <button class="tf-btn active" onclick="changeTf('15m', this)">15M</button>
    </div>

    <script>
        let chart, candleSeries, socket, countdownTimer;
        let savedPrices = JSON.parse(localStorage.getItem('elite_levels') || '[]');
        let eliteLines = [];
        let isMoving = false;
        let movingIndex = -1;

        // ÿØÿßŸÑÿ© ÿßŸÑÿ®ÿØÿ° ÿßŸÑÿ£ŸÉŸäÿØ (ŸÑÿ≠ŸÑ ŸÖÿ¥ŸÉŸÑÿ© ÿßÿÆÿ™ŸÅÿßÿ° ÿßŸÑÿ¥ŸÖŸàÿπ ŸÅŸä WebView)
        window.onload = function() {
            initChart();
            updateChartData('15m');
        };

        function initChart() {
            chart = LightweightCharts.createChart(document.getElementById('chart'), {
                layout: { background: { color: '#000000' }, textColor: '#FFD700' },
                grid: { vertLines: { visible: false }, horzLines: { visible: false } },
                rightPriceScale: { borderColor: '#FFD700' },
                timeScale: { borderColor: '#FFD700', timeVisible: true }
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#FFD700', downColor: '#000',
                borderUpColor: '#FFD700', borderDownColor: '#FFD700',
                wickUpColor: '#FFD700', wickDownColor: '#FFD700'
            });

            setupTouchInteractions();
        }

        function renderLines() {
            eliteLines.forEach(l => candleSeries.removePriceLine(l));
            eliteLines = [];
            savedPrices.forEach((p, i) => {
                const line = candleSeries.createPriceLine({
                    price: p, color: '#FFD700', lineWidth: 2,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: true, title: 'LEVEL ' + (i+1)
                });
                eliteLines.push(line);
            });
        }

        function addEliteLine() {
            const data = candleSeries.data();
            if (data.length === 0) return;
            const price = data[data.length-1].close;
            savedPrices.push(price);
            localStorage.setItem('elite_levels', JSON.stringify(savedPrices));
            renderLines();
        }

        function setupTouchInteractions() {
            const chartElement = document.getElementById('chart');

            const getPriceFromY = (y) => {
                const rect = chartElement.getBoundingClientRect();
                return chart.priceScale('right').coordinateToPrice(y - rect.top);
            };

            // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÑŸÖÿ≥ ŸÑŸÑŸÖŸàÿ®ÿßŸäŸÑ ÿ®ÿØŸÇÿ© ÿπÿßŸÑŸäÿ©
            chartElement.addEventListener('touchstart', (e) => {
                const price = getPriceFromY(e.touches[0].clientY);
                movingIndex = savedPrices.findIndex(p => Math.abs(p - price) < 8);
                if (movingIndex !== -1) isMoving = true;
            }, { passive: false });

            chartElement.addEventListener('touchmove', (e) => {
                if (isMoving && movingIndex !== -1) {
                    e.preventDefault(); // ŸÖŸÜÿπ ÿ≥ÿ≠ÿ® ÿßŸÑÿµŸÅÿ≠ÿ©
                    const newPrice = getPriceFromY(e.touches[0].clientY);
                    savedPrices[movingIndex] = newPrice;
                    renderLines();
                }
            }, { passive: false });

            chartElement.addEventListener('touchend', () => {
                if (isMoving) {
                    localStorage.setItem('elite_levels', JSON.stringify(savedPrices));
                    isMoving = false;
                    movingIndex = -1;
                }
            });
        }

        async function updateChartData(interval) {
            try {
                const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=PAXGUSDT&interval=${interval}&limit=500`);
                const raw = await res.json();
                candleSeries.setData(raw.map(d => ({
                    time: d[0] / 1000, open: parseFloat(d[1]), high: parseFloat(d[2]), low: parseFloat(d[3]), close: parseFloat(d[4])
                })));
                renderLines();
                connectSocket(interval);
                setupCountdown(interval);
            } catch (e) { console.error("Error loading data:", e); }
        }

        function connectSocket(interval) {
            if (socket) socket.close();
            socket = new WebSocket(`wss://stream.binance.com:9443/ws/paxgusdt@kline_${interval}`);
            socket.onmessage = (e) => {
                const k = JSON.parse(e.data).k;
                candleSeries.update({ time: k.t / 1000, open: parseFloat(k.o), high: parseFloat(k.h), low: parseFloat(k.l), close: parseFloat(k.c) });
            };
        }

        function setupCountdown(interval) {
            if (countdownTimer) clearInterval(countdownTimer);
            const ms = parseInt(interval) * 60000;
            countdownTimer = setInterval(() => {
                const left = ms - (Date.now() % ms);
                document.getElementById('countdown').innerText = 
                    `${Math.floor(left/60000).toString().padStart(2,'0')}:${Math.floor((left%60000)/1000).toString().padStart(2,'0')}`;
            }, 1000);
        }

        function changeTf(tf, btn) {
            document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateChartData(tf);
        }

        function clearAllDrawings() {
            if(confirm("ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™ÿü")) {
                savedPrices = [];
                localStorage.removeItem('elite_levels');
                renderLines();
            }
        }
    </script>
</body>
</html>
